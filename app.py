import streamlit as st
import pandas as pd
import plotly.express as px
import datetime

# --- Configuraci칩n de la P치gina ---
st.set_page_config(
    page_title="Dashboard Ejecutivo de Operaciones",
    page_icon="游늵",
    layout="wide"
)

# --- T칤tulo Principal ---
st.title("游늵 Dashboard Ejecutivo de Operaciones")
st.markdown("### An치lisis Detallado de Operaciones")

# --- Carga de Datos ---
df = None
VOLUME_COLUMN = 'TONELAJE' # Columna de volumen, AJUSTA SI ES NECESARIO
# !!! IMPORTANTE: Asumiendo que la columna 'L' es donde est치n los nombres de las empresas de transporte.
# Si en tu archivo Excel, la columna de empresa se llama diferente, por favor AJUSTA ESTA L칈NEA.
EMPRESA_COLUMN = 'L' 
GUIA_COLUMN_IDENTIFIER = None # Usaremos el conteo de filas si no hay una columna espec칤fica para gu칤as. Si la hay, dime el nombre.
REGULACION_COLUMNS_TO_COUNT = ['REGULACION 1', 'REGULACION 2', 'REGULACION 3'] # Columnas a considerar para contar regulaciones

uploaded_file = st.sidebar.file_uploader("Carga tu archivo Excel (.xlsx)", type=["xlsx"])

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.sidebar.success("Archivo cargado correctamente!")

        # --- Preprocesamiento de Datos ---
        # Convertir FECHA
        try:
            df['FECHA'] = pd.to_datetime(df['FECHA'], format='%d-%m-%Y', errors='coerce')
        except ValueError:
            try:
                df['FECHA'] = pd.to_datetime(df['FECHA'], errors='coerce') # Intenta parseo autom치tico si el formato DD-MM-YYYY falla
            except Exception as e:
                st.error(f"Error al convertir la columna 'FECHA'. Aseg칰rate de que tenga un formato de fecha reconocible. Detalle: {e}")
                st.stop()
        df.dropna(subset=['FECHA'], inplace=True)

        # Validar VOLUME_COLUMN
        if VOLUME_COLUMN not in df.columns:
            st.error(f"Error: No se encontr칩 la columna '{VOLUME_COLUMN}'. Por favor, verifica el nombre de la columna en tu archivo Excel y aj칰stalo en la variable `VOLUME_COLUMN`.")
            st.stop()
        df[VOLUME_COLUMN] = pd.to_numeric(df[VOLUME_COLUMN], errors='coerce')
        df.dropna(subset=[VOLUME_COLUMN], inplace=True)

        # Validar columnas clave
        if 'PRODUCTO' not in df.columns:
            st.error("Error: No se encontr칩 la columna 'PRODUCTO'.")
            st.stop()
        
        # Validar Columna de Empresa
        if EMPRESA_COLUMN not in df.columns:
            st.error(f"Error: No se encontr칩 la columna '{EMPRESA_COLUMN}'. Por favor, verifica que la columna para las empresas se llame exactamente '{EMPRESA_COLUMN}'.")
            st.stop()

        # Mapeo de nombres de empresas para estandarizar
        empresa_mapping = {
            "JORQUERA TRANSPORTE S. A.": "JORQUERA TRANSPORTE S. A.",
            "JORQUERA TRANSPORTE S A": "JORQUERA TRANSPORTE S. A.",
            "MINING SERVICES AND DERIVATES": "M S & D SPA",
            "MINING SERVICES AND DERIVATES SPA": "M S & D SPA",
            "M S AND D": "M S & D SPA",
            "M S AND D SPA": "M S & D SPA",
            "MSANDD SPA": "M S & D SPA",
            "M S D": "M S & D SPA",
            "M S D SPA": "M S & D SPA",
            "M S & D": "M S & D SPA",
            "MS&D SPA": "M S & D SPA",
            "M AND Q SPA": "M&Q SPA",
            "M AND Q": "M&Q SPA",
            "M Q SPA": "M&Q SPA",
            "MQ SPA": "M&Q SPA",
            "MANDQ SPA": "M&Q SPA",
            "MINING AND QUARRYING SPA": "M&Q SPA",
            "MINING AND QUARRYNG SPA": "M&Q SPA",
            "AG SERVICE SPA": "AG SERVICES SPA",
            "AG SERVICES SPA": "AG SERVICES SPA",
            "COSEDUCAM S A": "COSEDUCAM S A",
            "COSEDUCAM": "COSEDUCAM S A"
        }
        # Aplicar el mapeo. Si la empresa no est치 en el mapeo, se mantiene su valor original.
        df[EMPRESA_COLUMN] = df[EMPRESA_COLUMN].map(empresa_mapping).fillna(df[EMPRESA_COLUMN])


        # Validar columnas de regulaci칩n
        for col in REGULACION_COLUMNS_TO_COUNT:
            if col not in df.columns:
                st.warning(f"Advertencia: No se encontr칩 la columna de regulaci칩n '{col}'. El an치lisis de regulaciones podr칤a verse afectado.")

        # --- Filtro por Fecha ---
        st.sidebar.header("Filtros de Datos")
        fechas_disponibles = df['FECHA'].dt.date.unique()
        fechas_disponibles_ordenadas = sorted(fechas_disponibles)

        if not fechas_disponibles_ordenadas:
            st.warning("No se encontraron fechas v치lidas en el archivo cargado.")
            st.stop()

        fecha_por_defecto = fechas_disponibles_ordenadas[0]
        fecha_seleccionada = st.sidebar.date_input(
            "Selecciona una Fecha:",
            value=fecha_por_defecto,
            min_value=fechas_disponibles_ordenadas[0],
            max_value=fechas_disponibles_ordenadas[-1]
        )
        fecha_dt_seleccionada = pd.to_datetime(fecha_seleccionada)
        df_filtrado_fecha = df[df['FECHA'].dt.date == fecha_dt_seleccionada.date()]

        # --- Renderizado del Dashboard ---
        st.header(f"An치lisis para el {fecha_dt_seleccionada.strftime('%d-%m-%Y')}")

        if not df_filtrado_fecha.empty:
            tonelaje_total_dia = df_filtrado_fecha[VOLUME_COLUMN].sum()
            productos_distintos_dia = df_filtrado_fecha['PRODUCTO'].nunique()

            col1, col2 = st.columns(2)
            with col1:
                st.metric(label="Tonelaje Total del D칤a", value=f"{tonelaje_total_dia:,.2f} Ton")
            with col2:
                st.metric(label="Productos Distintos", value=productos_distintos_dia)

            # --- Agrupaci칩n de Datos para Gr치ficos y Insights ---

            # 1. Gr치fico por Empresa
            tonelaje_por_empresa = None
            if EMPRESA_COLUMN in df_filtrado_fecha.columns:
                tonelaje_por_empresa = df_filtrado_fecha.groupby(EMPRESA_COLUMN)[VOLUME_COLUMN].sum().sort_values(ascending=False).reset_index()

            # 2. Gr치fico por Destino del Producto
            tonelaje_por_destino = df_filtrado_fecha.groupby('DESTINO')[VOLUME_COLUMN].sum().sort_values(ascending=False).reset_index()

            # 3. Gr치fico por Cantidad de Gu칤as Emitidas por Producto
            if GUIA_COLUMN_IDENTIFIER and GUIA_COLUMN_IDENTIFIER in df_filtrado_fecha.columns:
                guias_por_producto = df_filtrado_fecha.groupby('PRODUCTO')[GUIA_COLUMN_IDENTIFIER].nunique().reset_index(name='CANTIDAD_GUIAS')
            else:
                guias_por_producto = df_filtrado_fecha.groupby('PRODUCTO').size().reset_index(name='CANTIDAD_GUIAS')

            # 4. Gr치fico por Tonelaje de Cada Producto
            tonelaje_por_producto_detail = df_filtrado_fecha.groupby('PRODUCTO')[VOLUME_COLUMN].sum().sort_values(ascending=False).reset_index()

            # 5. Gr치fico por Cantidad de Regulaciones que tenga cada Producto
            if all(col in df_filtrado_fecha.columns for col in REGULACION_COLUMNS_TO_COUNT):
                df_temp_regulaciones = df_filtrado_fecha.copy()
                for col in REGULACION_COLUMNS_TO_COUNT:
                    df_temp_regulaciones[f'tiene_{col}'] = df_temp_regulaciones[col].apply(lambda x: 1 if pd.notna(x) else 0)

                columnas_a_sumar = [f'tiene_{col}' for col in REGULACION_COLUMNS_TO_COUNT]
                regulaciones_por_producto = df_temp_regulaciones.groupby('PRODUCTO')[columnas_a_sumar].sum().sum(axis=1).reset_index(name='CANTIDAD_REGULACIONES')
            else:
                regulaciones_por_producto = pd.DataFrame()


            # --- Insights Clave ---
            st.subheader("游눠 Insights Clave")

            # Insight 1: Producto con Mayor Tonelaje
            if not tonelaje_por_producto_detail.empty:
                producto_mas_tonelaje_detail = tonelaje_por_producto_detail.iloc[0]
                mayor_tonelaje_prod_detail = producto_mas_tonelaje_detail[VOLUME_COLUMN]
                porcentaje_del_total_detail = (mayor_tonelaje_prod_detail / tonelaje_total_dia) * 100 if tonelaje_total_dia > 0 else 0
                st.markdown(f"- El producto con mayor volumen de tonelaje fue **'{producto_mas_tonelaje_detail['PRODUCTO']}'** con **{mayor_tonelaje_prod_detail:,.2f} toneladas**, representando el **{porcentaje_del_total_detail:.2f}%** del total diario.")
            else:
                st.markdown("- No hay datos de tonelaje por producto para esta fecha.")

            # Insight 2: Producto con M치s Gu칤as Emitidas
            if not guias_por_producto.empty:
                producto_mas_guias = guias_por_producto.iloc[0]
                st.markdown(f"- El producto con m치s gu칤as emitidas fue **'{producto_mas_guias['PRODUCTO']}'** con **{producto_mas_guias['CANTIDAD_GUIAS']} gu칤as**.")
            else:
                st.markdown("- No hay datos de gu칤as por producto para esta fecha.")
                
            # Insight 3: Producto con M치s Regulaciones
            if not regulaciones_por_producto.empty and 'CANTIDAD_REGULACIONES' in regulaciones_por_producto.columns:
                producto_mas_reg = regulaciones_por_producto.iloc[0]
                st.markdown(f"- El producto con m치s regulaciones registradas fue **'{producto_mas_reg['PRODUCTO']}'** con **{producto_mas_reg['CANTIDAD_REGULACIONES']} regulaciones**.")
            else:
                st.markdown("- No hay datos suficientes para determinar el producto con m치s regulaciones o las columnas de regulaci칩n no existen.")


            # --- Gr치ficos ---
            st.subheader("游늳 Visualizaciones")

            # Gr치fico 1: Por Empresa
            if tonelaje_por_empresa is not None and not tonelaje_por_empresa.empty:
                fig_empresa = px.bar(tonelaje_por_empresa,
                                     x=EMPRESA_COLUMN, y=VOLUME_COLUMN,
                                     title=f'Tonelaje por Empresa - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                     labels={EMPRESA_COLUMN: 'Empresa', VOLUME_COLUMN: 'Tonelaje (toneladas)'},
                                     color_discrete_sequence=px.colors.qualitative.Vivid)
                st.plotly_chart(fig_empresa, use_container_width=True)
            elif EMPRESA_COLUMN in df_filtrado_fecha.columns:
                 st.warning("No hay datos de tonelaje por empresa para mostrar el gr치fico.")


            # Gr치fico 2: Por Destino del Producto
            if not tonelaje_por_destino.empty:
                fig_destino = px.bar(tonelaje_por_destino,
                                     x='DESTINO', y=VOLUME_COLUMN,
                                     title=f'Tonelaje por Destino - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                     labels={'DESTINO': 'Destino', VOLUME_COLUMN: 'Tonelaje (toneladas)'},
                                     color_discrete_sequence=px.colors.qualitative.Alphabet)
                st.plotly_chart(fig_destino, use_container_width=True)
            else:
                st.warning("No hay datos de tonelaje por destino para mostrar el gr치fico.")

            # Gr치fico 3: Cantidad de Gu칤as Emitidas por Producto
            if not guias_por_producto.empty:
                fig_guias = px.bar(guias_por_producto,
                                   x='PRODUCTO', y='CANTIDAD_GUIAS',
                                   title=f'Cantidad de Gu칤as por Producto - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                   labels={'PRODUCTO': 'Producto', 'CANTIDAD_GUIAS': 'Nro. de Gu칤as'},
                                   color_discrete_sequence=px.colors.qualitative.G10)
                st.plotly_chart(fig_guias, use_container_width=True)
            else:
                st.warning("No hay datos de gu칤as por producto para mostrar el gr치fico.")

            # Gr치fico 4: Tonelaje de Cada Producto
            if not tonelaje_por_producto_detail.empty:
                fig_producto_tonelaje = px.bar(tonelaje_por_producto_detail,
                                                x='PRODUCTO', y=VOLUME_COLUMN,
                                                title=f'Tonelaje por Producto - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                                labels={'PRODUCTO': 'Producto', VOLUME_COLUMN: 'Tonelaje (toneladas)'},
                                                color_discrete_sequence=px.colors.qualitative.Pastel)
                st.plotly_chart(fig_producto_tonelaje, use_container_width=True)
            else:
                st.warning("No hay datos de tonelaje por producto para mostrar el gr치fico.")

            # Gr치fico 5: Cantidad de Regulaciones por Producto
            if not regulaciones_por_producto.empty and 'CANTIDAD_REGULACIONES' in regulaciones_por_producto.columns:
                 fig_regulaciones = px.bar(regulaciones_por_producto,
                                           x='PRODUCTO', y='CANTIDAD_REGULACIONES',
                                           title=f'Regulaciones por Producto - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                           labels={'PRODUCTO': 'Producto', 'CANTIDAD_REGULACIONES': 'Nro. de Regulaciones'},
                                           color_discrete_sequence=px.colors.qualitative.Plotly)
                 st.plotly_chart(fig_regulaciones, use_container_width=True)
            else:
                st.warning("No se ha podido calcular el gr치fico de regulaciones. Verifica la existencia de las columnas de regulaci칩n ('REGULACION 1', 'REGULACION 2', 'REGULACION 3') y que contengan datos.")


            # --- Tabla de Datos Filtrados ---
            st.subheader("游늶 Tabla de Datos Detallados")
            columnas_tabla = ['SECTOR', 'PRODUCTO', 'DESTINO', EMPRESA_COLUMN, VOLUME_COLUMN]
            columnas_existentes_tabla = [col for col in columnas_tabla if col in df_filtrado_fecha.columns]
            st.dataframe(df_filtrado_fecha[columnas_existentes_tabla], use_container_width=True)

        else:
            st.warning(f"No se encontraron datos para la fecha seleccionada: {fecha_dt_seleccionada.strftime('%d-%m-%Y')}")
            st.info("Por favor, selecciona otra fecha del men칰 lateral.")

    except Exception as e:
        st.error(f"Ocurri칩 un error durante el procesamiento de los datos: {e}")
        st.exception(e)

else:
    st.info("Por favor, carga tu archivo Excel (.xlsx) en la barra lateral para comenzar.")

# --- Pie de P치gina ---
st.sidebar.markdown("---")
st.sidebar.markdown("Desarrollado con Streamlit, Pandas y Plotly.")