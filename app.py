import streamlit as st
import pandas as pd
import plotly.express as px
import datetime

# --- Configuraci칩n de la P치gina ---
st.set_page_config(
    page_title="Dashboard Ejecutivo de Operaciones",
    page_icon="游늵",
    layout="wide"
)

# --- T칤tulo Principal ---
st.title("游늵 Dashboard Ejecutivo de Operaciones")
st.markdown("### An치lisis de Tonelaje por Fecha, Producto y Sector")

# --- Carga de Datos ---

# Variable para almacenar el DataFrame
df = None

# Widget para subir archivos
uploaded_file = st.sidebar.file_uploader("Carga tu archivo Excel (.xlsx)", type=["xlsx"])

# --- Preprocesamiento de Datos ---

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.sidebar.success("Archivo cargado correctamente!")

        # 1. Convertir la columna 'FECHA' a formato datetime
        # Asumiendo que tu fecha est치 en formato DD-MM-YYYY.
        # Si tu formato es diferente, aj칰stalo en `format=`.
        # Intenta con formatos comunes si el primero falla.
        try:
            df['FECHA'] = pd.to_datetime(df['FECHA'], format='%d-%m-%Y', errors='coerce')
        except ValueError:
            try:
                df['FECHA'] = pd.to_datetime(df['FECHA'], errors='coerce') # Intenta con parseo autom치tico
            except Exception as e:
                st.error(f"Error al convertir la columna 'FECHA'. Aseg칰rate de que tenga un formato de fecha reconocible. Detalle: {e}")
                st.stop()

        # Eliminar filas donde la conversi칩n de fecha fall칩
        df.dropna(subset=['FECHA'], inplace=True)

        # 2. Limpiar y convertir la columna de volumen/tonelaje
        # ASUME que tu columna de volumen se llama 'TONELAJE'.
        # Si se llama diferente (ej: 'Volumen', 'Cantidad'), c치mbialo aqu칤:
        VOLUME_COLUMN = 'TONELAJE' # <-- CAMBIA ESTO SI TU COLUMNA SE LLAMA DIFERENTE

        if VOLUME_COLUMN not in df.columns:
            st.error(f"Error: No se encontr칩 la columna '{VOLUME_COLUMN}'. Por favor, verifica el nombre de la columna en tu archivo Excel y aj칰stalo en la variable `VOLUME_COLUMN` en este script.")
            st.stop()

        df[VOLUME_COLUMN] = pd.to_numeric(df[VOLUME_COLUMN], errors='coerce')
        df.dropna(subset=[VOLUME_COLUMN], inplace=True)

        # Asegurarse de que las columnas de agrupaci칩n existan
        if 'PRODUCTO' not in df.columns:
            st.error("Error: No se encontr칩 la columna 'PRODUCTO' en el archivo Excel.")
            st.stop()
        if 'SECTOR' not in df.columns:
            st.warning("Advertencia: No se encontr칩 la columna 'SECTOR'. Algunas visualizaciones y an치lisis no estar치n disponibles.")

        # --- Filtro por Fecha ---
        st.sidebar.header("Filtros de Datos")

        # Obtener las fechas 칰nicas disponibles para el selector
        fechas_disponibles = df['FECHA'].dt.date.unique()
        fechas_disponibles_ordenadas = sorted(fechas_disponibles)

        if not fechas_disponibles_ordenadas:
            st.warning("No se encontraron fechas v치lidas en el archivo cargado.")
            st.stop()

        # Establecer una fecha por defecto, si es posible, la primera disponible en los datos
        fecha_por_defecto = fechas_disponibles_ordenadas[0]

        fecha_seleccionada = st.sidebar.date_input(
            "Selecciona una Fecha:",
            value=fecha_por_defecto,
            min_value=fechas_disponibles_ordenadas[0],
            max_value=fechas_disponibles_ordenadas[-1]
        )

        # Convertir la fecha seleccionada por el usuario a un formato comparable con la columna 'FECHA'
        fecha_dt_seleccionada = pd.to_datetime(fecha_seleccionada)

        # Filtrar el DataFrame seg칰n la fecha seleccionada
        df_filtrado_fecha = df[df['FECHA'].dt.date == fecha_dt_seleccionada.date()]

        # --- Renderizado del Dashboard ---
        st.header(f"An치lisis para el {fecha_dt_seleccionada.strftime('%d-%m-%Y')}")

        if not df_filtrado_fecha.empty:
            tonelaje_total_dia = df_filtrado_fecha[VOLUME_COLUMN].sum()
            productos_distintos_dia = df_filtrado_fecha['PRODUCTO'].nunique()
            sectores_presentes = df_filtrado_fecha['SECTOR'].nunique() if 'SECTOR' in df_filtrado_fecha.columns else 0

            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric(label="Tonelaje Total del D칤a", value=f"{tonelaje_total_dia:,.2f} Ton")
            with col2:
                st.metric(label="Productos Distintos", value=productos_distintos_dia)
            if 'SECTOR' in df_filtrado_fecha.columns:
                with col3:
                    st.metric(label="Sectores Presentes", value=sectores_presentes)

            # --- Agrupaci칩n de Datos para Gr치ficos y Insights ---
            tonelaje_por_producto = df_filtrado_fecha.groupby('PRODUCTO')[VOLUME_COLUMN].sum().sort_values(ascending=False).reset_index()
            tonelaje_por_sector = None
            if 'SECTOR' in df_filtrado_fecha.columns:
                tonelaje_por_sector = df_filtrado_fecha.groupby('SECTOR')[VOLUME_COLUMN].sum().sort_values(ascending=False).reset_index()

            # --- Insights Clave ---
            st.subheader("游눠 Insights Clave")

            # Insight 1: Producto con Mayor Tonelaje
            if not tonelaje_por_producto.empty:
                producto_mas_tonelaje = tonelaje_por_producto.iloc[0]
                mayor_tonelaje_prod = producto_mas_tonelaje[VOLUME_COLUMN]
                porcentaje_del_total = (mayor_tonelaje_prod / tonelaje_total_dia) * 100 if tonelaje_total_dia > 0 else 0
                st.markdown(f"- El producto con mayor volumen de tonelaje fue **'{producto_mas_tonelaje['PRODUCTO']}'** con **{mayor_tonelaje_prod:,.2f} toneladas**, representando el **{porcentaje_del_total:.2f}%** del total diario.")
            else:
                st.markdown("- No hay datos de tonelaje por producto para esta fecha.")

            # Insight 2: Sector con Mayor Tonelaje
            if tonelaje_por_sector is not None and not tonelaje_por_sector.empty:
                sector_mas_tonelaje = tonelaje_por_sector.iloc[0]
                st.markdown(f"- El sector que movi칩 m치s tonelaje fue **'{sector_mas_tonelaje['SECTOR']}'** con **{sector_mas_tonelaje[VOLUME_COLUMN]:,.2f} toneladas**.")
            elif 'SECTOR' in df_filtrado_fecha.columns:
                st.markdown("- No hay datos de sector disponibles para el an치lisis.")

            # --- Gr치ficos ---
            st.subheader("游늳 Visualizaciones")

            # Gr치fico de Barras: Tonelaje por Producto
            if not tonelaje_por_producto.empty:
                fig_producto = px.bar(tonelaje_por_producto,
                                        x='PRODUCTO',
                                        y=VOLUME_COLUMN,
                                        title=f'Tonelaje por Producto - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                        labels={'PRODUCTO': 'Producto', VOLUME_COLUMN: 'Tonelaje (toneladas)'},
                                        color_discrete_sequence=px.colors.qualitative.Pastel)
                fig_producto.update_layout(xaxis_title="Producto", yaxis_title="Tonelaje (toneladas)")
                st.plotly_chart(fig_producto, use_container_width=True)
            else:
                st.warning("No hay datos de tonelaje por producto para mostrar el gr치fico.")

            # Gr치fico de Barras: Tonelaje por Sector
            if tonelaje_por_sector is not None and not tonelaje_por_sector.empty:
                fig_sector = px.bar(tonelaje_por_sector,
                                    x='SECTOR',
                                    y=VOLUME_COLUMN,
                                    title=f'Tonelaje por Sector - {fecha_dt_seleccionada.strftime("%d-%m-%Y")}',
                                    labels={'SECTOR': 'Sector', VOLUME_COLUMN: 'Tonelaje (toneladas)'},
                                    color_discrete_sequence=px.colors.qualitative.Set3)
                fig_sector.update_layout(xaxis_title="Sector", yaxis_title="Tonelaje (toneladas)")
                st.plotly_chart(fig_sector, use_container_width=True)
            elif 'SECTOR' in df_filtrado_fecha.columns:
                st.warning("No hay datos de tonelaje por sector para mostrar el gr치fico.")

            # --- Tabla de Datos Filtrados ---
            st.subheader("游늶 Tabla de Datos Detallados")
            columnas_tabla = ['SECTOR', 'PRODUCTO', 'DESTINO', VOLUME_COLUMN]
            columnas_existentes_tabla = [col for col in columnas_tabla if col in df_filtrado_fecha.columns]
            st.dataframe(df_filtrado_fecha[columnas_existentes_tabla], use_container_width=True)

        else:
            st.warning(f"No se encontraron datos para la fecha seleccionada: {fecha_dt_seleccionada.strftime('%d-%m-%Y')}")
            st.info("Por favor, selecciona otra fecha del men칰 lateral.")

    except Exception as e:
        st.error(f"Ocurri칩 un error durante el procesamiento de los datos: {e}")

else:
    st.info("Por favor, carga tu archivo Excel (.xlsx) en la barra lateral para comenzar.")

# --- Pie de P치gina ---
st.sidebar.markdown("---")
st.sidebar.markdown("Desarrollado con Streamlit, Pandas y Plotly.")